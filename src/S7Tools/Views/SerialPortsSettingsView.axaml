<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:S7Tools.ViewModels"
             xmlns:conv="using:S7Tools.Converters"
             xmlns:icons="using:Projektanker.Icons.Avalonia"
             xmlns:fa="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="S7Tools.Views.SerialPortsSettingsView"
             x:DataType="vm:SerialPortsSettingsViewModel"
             Background="#1E1E1E">

  <UserControl.Resources>
    <conv:BooleanToInverseBooleanConverter x:Key="InvBool" />
  </UserControl.Resources>

  <ScrollViewer>
    <StackPanel Margin="20" Spacing="12">
      <!-- Header -->
      <TextBlock Text="Serial Ports Settings"
                 FontSize="24"
                 FontWeight="Bold"
                 Foreground="#CCCCCC"
                 Margin="0,0,0,10" />

      <!-- Profile Management Section -->
      <Border Background="#252526"
              BorderBrush="#464647"
              BorderThickness="1"
              CornerRadius="4"
              Padding="16">
        <StackPanel Spacing="8">
          <TextBlock Text="Profile Management"
                     FontSize="18"
                     FontWeight="SemiBold"
                     Foreground="#CCCCCC" />

          <!-- Profiles Path was moved to Import/Export section -->

          <!-- Create New Profile -->
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="120" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock Grid.Column="0" Grid.Row="0"
                       Text="New Profile:"
                       Foreground="#CCCCCC"
                       VerticalAlignment="Center" />

            <TextBox Grid.Column="1" Grid.Row="0"
                     Text="{Binding NewProfileName}"
                     Watermark="Profile name..."
                     MaxLength="20"
                     Background="#3C3C3C"
                     Foreground="#CCCCCC"
                     BorderBrush="#464647"
                     Margin="8,0" />

            <TextBox Grid.Column="2" Grid.Row="0"
                     Text="{Binding NewProfileDescription}"
                     Watermark="Description (optional)..."
                     MaxLength="60"
                     Background="#3C3C3C"
                     Foreground="#CCCCCC"
                     BorderBrush="#464647"
                     Margin="8,0" />

            <Button Grid.Column="3" Grid.Row="0"
                    Background="#0E639C"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="12,6"
                    Command="{Binding CreateProfileCommand}">
              <StackPanel Orientation="Horizontal" Spacing="6">
                <icons:Icon Value="fa-solid fa-plus" Width="14" Height="14" />
                <TextBlock Text="Create" />
              </StackPanel>
            </Button>

            <TextBlock Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="2"
                       Text="Create a new serial port configuration profile"
                       FontSize="11"
                       Foreground="#858585"
                       Margin="8,4,0,0" />
          </Grid>

          <!-- Profiles List -->
          <StackPanel>
            <!-- Toolbar above the DataGrid -->
            <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
              <Button Width="110" Height="34" Command="{Binding EditProfileCommand}" Background="#0E639C" Foreground="White">
                <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
                  <icons:Icon Value="fa-solid fa-edit" Width="14" Height="14" />
                  <TextBlock Text="Edit" />
                </StackPanel>
              </Button>

              <Button Width="110" Height="34" Command="{Binding DeleteProfileCommand}" Background="#D13438" Foreground="White">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <icons:Icon Value="fa-solid fa-trash" Width="14" Height="14" />
                  <TextBlock Text="Delete" />
                </StackPanel>
              </Button>

              <Button Width="110" Height="34" Command="{Binding DuplicateProfileCommand}" Background="#0E639C" Foreground="White">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <icons:Icon Value="fa-solid fa-copy" Width="14" Height="14" />
                  <TextBlock Text="Duplicate" />
                </StackPanel>
              </Button>

              <Button Width="110" Height="34" Command="{Binding SetDefaultProfileCommand}" Background="#0E639C" Foreground="White">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <icons:Icon Value="fa-solid fa-star" Width="14" Height="14" />
                  <TextBlock Text="Set Default" />
                </StackPanel>
              </Button>

              <Button Width="110" Height="34" Command="{Binding ShowProfileDetailsCommand}" Background="Transparent" BorderBrush="#464647" Foreground="#CCCCCC">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <icons:Icon Value="fa-solid fa-info-circle" Width="14" Height="14" />
                  <TextBlock Text="Details" />
                </StackPanel>
              </Button>

              <Button Width="110" Height="34" Command="{Binding RefreshProfilesCommand}" Background="Transparent" BorderBrush="#464647" Foreground="#CCCCCC">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <icons:Icon Value="fa-solid fa-sync" Width="14" Height="14" />
                  <TextBlock Text="Refresh" />
                </StackPanel>
              </Button>
            </StackPanel>

            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <DataGrid Grid.Column="0"
                        ItemsSource="{Binding Profiles}"
                        SelectedItem="{Binding SelectedProfile}"
                        Background="#3C3C3C"
                        Foreground="#CCCCCC"
                        GridLinesVisibility="Horizontal"
                        HeadersVisibility="Column"
                        CanUserReorderColumns="False"
                        CanUserResizeColumns="True"
                        CanUserSortColumns="True"
                        IsReadOnly="True"
                        Height="200"
                        Margin="0,0,0,8">
              <!-- Header style using Avalonia style selector (matches LogViewer pattern) -->
              <DataGrid.Styles>
                <Style Selector="DataGridColumnHeader">
                  <!-- Reduce font size and right padding so headers take less horizontal space -->
                    <Setter Property="FontSize" Value="11" />
                    <Setter Property="FontWeight" Value="SemiBold" />
                    <!-- Left padding small, right padding larger to reserve space for sort glyph -->
                    <Setter Property="Padding" Value="8,4,32,4" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <!-- Ensure header content is actually displayed by binding Content to the presenter -->
                    <Setter Property="Template">
                      <ControlTemplate>
                        <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                          <DockPanel>
                            <!-- Header content: present the header Content (TemplateBinding Content) -->
                            <ContentPresenter Content="{TemplateBinding Content}"
                                              DockPanel.Dock="Left"
                                              VerticalAlignment="Center" />

                            <!-- (removed duplicate presenter that caused "already has a visual parent" errors) -->
                          </DockPanel>
                        </Border>
                      </ControlTemplate>
                    </Setter>
                </Style>
              </DataGrid.Styles>

              <DataGrid.Columns>
                <!-- ID Column: First column to show profile ID -->
                <DataGridTextColumn Binding="{Binding Id}" Width="50" MinWidth="40">
                  <DataGridTextColumn.Header>
                    <TextBlock Text="ID" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridTextColumn.Header>
                </DataGridTextColumn>

                <!-- Name: slightly smaller min width so headers don't appear too large -->
                <DataGridTextColumn Binding="{Binding Name}" Width="160" MinWidth="120">
                  <DataGridTextColumn.Header>
                    <TextBlock Text="Name" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridTextColumn.Header>
                </DataGridTextColumn>

                <!-- Description: allow more flexible width but reduce excessive min width -->
                <DataGridTextColumn Binding="{Binding Description}" Width="480" MinWidth="140">
                  <DataGridTextColumn.Header>
                    <TextBlock Text="Description" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridTextColumn.Header>
                </DataGridTextColumn>

                <!-- Small fixed columns use Auto so header fits content and arrow -->
                <DataGridTextColumn Binding="{Binding Configuration.BaudRate}" Width="90" MinWidth="70">
                  <DataGridTextColumn.Header>
                    <TextBlock Text="Baud Rate" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridTextColumn.Header>
                </DataGridTextColumn>

                <DataGridTextColumn Binding="{Binding Configuration.Parity}" Width="80" MinWidth="70">
                  <DataGridTextColumn.Header>
                    <TextBlock Text="Parity" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridTextColumn.Header>
                </DataGridTextColumn>

                <DataGridCheckBoxColumn Binding="{Binding IsDefault}" Width="70" MinWidth="60">
                  <DataGridCheckBoxColumn.Header>
                    <TextBlock Text="Default" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridCheckBoxColumn.Header>
                </DataGridCheckBoxColumn>

                <DataGridCheckBoxColumn Binding="{Binding IsReadOnly}" Width="80" MinWidth="70">
                  <DataGridCheckBoxColumn.Header>
                    <TextBlock Text="Read-Only" Margin="0,0,8,0" TextTrimming="CharacterEllipsis" />
                  </DataGridCheckBoxColumn.Header>
                </DataGridCheckBoxColumn>
              </DataGrid.Columns>
            </DataGrid>
          </Grid>
          </StackPanel>

          <!-- Profile Statistics -->
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Profiles Path controls removed from here and moved to Import/Export section -->

            <TextBlock Grid.Column="0"
                       Text="{Binding ProfileCount, StringFormat='Total Profiles: {0}'}"
                       Foreground="#858585"
                       FontSize="12" />

            <TextBlock Grid.Column="1"
                       Text="{Binding StatusMessage}"
                       Foreground="#858585"
                       FontSize="12" />

            <TextBlock Grid.Column="2"
                       Text=""
                       Foreground="#858585"
                       FontSize="12" />
          </Grid>
        </StackPanel>
      </Border>

      <!-- Port Discovery Section -->
      <Border Background="#252526"
              BorderBrush="#464647"
              BorderThickness="1"
              CornerRadius="4"
              Padding="16">
        <StackPanel Spacing="16">
          <!-- Row 1: Port Discovery Title + Scan Ports Button -->
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                       Text="Port Discovery"
                       FontSize="18"
                       FontWeight="SemiBold"
                       Foreground="#CCCCCC"
                       VerticalAlignment="Center" />

            <Button Grid.Column="2"
                    Background="#0E639C"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="12,8"
                    Command="{Binding ScanPortsCommand}"
                    IsEnabled="{Binding IsScanning, Converter={StaticResource InvBool}}">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <icons:Icon Value="fa-solid fa-search" Width="16" Height="16" />
                <TextBlock Text="Scan Ports" />
              </StackPanel>
            </Button>
          </Grid>

          <!-- Row 2: The wrap list with the scanned ports -->
          <Grid Background="Transparent">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
              <ListBox x:Name="PortsListBox"
                       Height="160"
                       ItemsSource="{Binding AvailablePorts}"
                       SelectedItem="{Binding SelectedPort}"
                       Background="#3C3C3C"
                       Foreground="#CCCCCC"
                       BorderBrush="#464647"
                       ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                       ScrollViewer.VerticalScrollBarVisibility="Disabled"
                       Focusable="False">
                <!-- Use a WrapPanel so ports fill top->down then next column with proper spacing -->
                <ListBox.ItemsPanel>
                  <ItemsPanelTemplate>
                    <WrapPanel Orientation="Vertical" ItemWidth="140" ItemHeight="32" />
                  </ItemsPanelTemplate>
                </ListBox.ItemsPanel>

                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <!-- No rounded corners, tighter width, proper spacing -->
                    <Border Background="#2D2D2D"
                            CornerRadius="0"
                            Padding="8,6"
                            Margin="6,3"
                            Width="130"
                            Height="26">
                      <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                        <icons:Icon Value="fa-solid fa-plug" Width="12" Height="12" Foreground="#0E639C" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding}" Foreground="#CCCCCC" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" FontSize="11" />
                      </StackPanel>
                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>
              </ListBox>
            </ScrollViewer>

            <!-- Overlay: semi-transparent backdrop with a centered ProgressRing when scanning -->
            <Border Background="#000000" Opacity="0.45" IsVisible="{Binding IsScanning}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
              <Grid HorizontalAlignment="Center" VerticalAlignment="Center">
                <fa:ProgressRing Width="64" Height="64" IsActive="{Binding IsScanning}" />
              </Grid>
            </Border>
          </Grid>

          <!-- Row 3: Found ports text and Selected port text -->
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                       Text="{Binding StatusMessage}"
                       Foreground="#858585"
                       FontSize="12"
                       VerticalAlignment="Center" />

            <TextBlock Grid.Column="1"
                       Text="{Binding SelectedPort, StringFormat='Selected: {0}', FallbackValue='Selected: None'}"
                       Foreground="#858585"
                       FontSize="12"
                       VerticalAlignment="Center" />

            <TextBlock Grid.Column="2"
                       Text=""
                       Foreground="#858585"
                       FontSize="12" />
          </Grid>

          <!-- Row 4: Test Port Button + STTY Command inline -->
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Vertical" Spacing="4" Margin="0,0,16,0">
              <TextBlock Text="Test Port:" Foreground="#CCCCCC" FontWeight="SemiBold" />
              <Button Background="#0E639C"
                      Foreground="White"
                      BorderThickness="0"
                      Padding="12,8"
                      Command="{Binding TestPortCommand}">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <icons:Icon Value="fa-solid fa-play" Width="14" Height="14" />
                  <TextBlock Text="Test Port" />
                </StackPanel>
              </Button>
            </StackPanel>

            <StackPanel Grid.Column="1" Spacing="4">
              <TextBlock Text="Profile STTY Command:" Foreground="#CCCCCC" FontWeight="SemiBold" />
              <TextBox Text="{Binding SelectedProfileSttyString}"
                       IsReadOnly="True"
                       Background="#1E1E1E"
                       Foreground="#CCCCCC"
                       BorderBrush="#464647"
                       Height="56"
                       TextWrapping="Wrap" />
            </StackPanel>
          </Grid>
        </StackPanel>
      </Border>

      <!-- Import/Export Section -->
      <Border Background="#252526"
              BorderBrush="#464647"
              BorderThickness="1"
              CornerRadius="4"
              Padding="16">
        <StackPanel Spacing="16">
          <TextBlock Text="Import/Export"
                     FontSize="18"
                     FontWeight="SemiBold"
                     Foreground="#CCCCCC" />

          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="24">
            <Button Width="140" Background="#0E639C" Foreground="White" BorderThickness="0" Padding="12,8" Command="{Binding ExportProfilesCommand}">
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <icons:Icon Value="fa-solid fa-download" Width="16" Height="16" />
                <TextBlock Text="Export All" />
              </StackPanel>
            </Button>

            <Button Width="160" Background="#0E639C" Foreground="White" BorderThickness="0" Padding="12,8" Command="{Binding ExportSelectedProfileCommand}">
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <icons:Icon Value="fa-solid fa-file-download" Width="16" Height="16" />
                <TextBlock Text="Export Selected" />
              </StackPanel>
            </Button>

            <Button Width="120" Background="#0E639C" Foreground="White" BorderThickness="0" Padding="12,8" Command="{Binding ImportProfilesCommand}">
              <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <icons:Icon Value="fa-solid fa-upload" Width="16" Height="16" />
                <TextBlock Text="Import" />
              </StackPanel>
            </Button>
          </StackPanel>

          <TextBlock Text="Export profiles to JSON files for backup or sharing. Import profiles from previously exported files."
                     FontSize="11"
                     Foreground="#858585"
                     TextWrapping="Wrap" />

          <!-- Profiles Path controls (moved from Profile Management) -->
          <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
            <TextBlock Text="Profiles Path:" Foreground="#CCCCCC" VerticalAlignment="Center" />
            <TextBox Width="420" Text="{Binding ProfilesPath}" Background="#3C3C3C" Foreground="#CCCCCC" BorderBrush="#464647" Margin="8,0" />
            <Button Content="Browse..." Background="#0E639C" Foreground="White" BorderThickness="0" Padding="12,6" Command="{Binding BrowseProfilesPathCommand}" />
            <Button Background="Transparent" Foreground="#CCCCCC" BorderBrush="#464647" BorderThickness="1" Padding="8,6" ToolTip.Tip="Open in Explorer" Command="{Binding OpenProfilesPathCommand}">
              <icons:Icon Value="fa-solid fa-external-link-alt" Width="14" Height="14" />
            </Button>
            <Button Content="Load Default" Background="#007ACC" Foreground="White" BorderThickness="0" Padding="8,6" Command="{Binding ResetProfilesPathCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Status Section -->
      <Border Background="#252526"
              BorderBrush="#464647"
              BorderThickness="1"
              CornerRadius="4"
              Padding="16">
        <StackPanel Spacing="8">
          <TextBlock Text="Status Information"
                     FontSize="18"
                     FontWeight="SemiBold"
                     Foreground="#CCCCCC" />

          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Spacing="4">
              <TextBlock Text="Profile Management:"
                         Foreground="#CCCCCC"
                         FontWeight="SemiBold" />
              <TextBlock Text="{Binding ProfileCount, StringFormat='• {0} profiles loaded'}"
                         Foreground="#858585"
                         FontSize="12" />
              <TextBlock Text="{Binding StatusMessage, StringFormat='• {0}'}"
                         Foreground="#858585"
                         FontSize="12" />
            </StackPanel>

            <StackPanel Grid.Column="1" Spacing="4">
              <TextBlock Text="Port Discovery:"
                         Foreground="#CCCCCC"
                         FontWeight="SemiBold" />
              <TextBlock Text="{Binding PortCount, StringFormat='• {0} ports discovered'}"
                         Foreground="#858585"
                         FontSize="12" />
              <TextBlock Text="{Binding SelectedPort, StringFormat='• Selected: {0}', FallbackValue='• No port selected'}"
                         Foreground="#858585"
                         FontSize="12" />
            </StackPanel>
          </Grid>

          <!-- Loading Indicator -->
          <StackPanel Orientation="Horizontal"
                      Spacing="8"
                      IsVisible="{Binding IsLoading}">
            <icons:Icon Value="fa-solid fa-spinner"
                        Width="16"
                        Height="16"
                        Foreground="#0E639C"
                        Classes="spin" />
            <TextBlock Text="Loading..."
                       Foreground="#858585"
                       FontSize="12" />
          </StackPanel>

          <!-- Status Message -->
          <TextBlock Text="{Binding StatusMessage}"
                     Foreground="#858585"
                     FontSize="12"
                     TextWrapping="Wrap" />
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
